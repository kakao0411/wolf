<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO対策：ページのタイトルを最適化 -->
    <title>ワードウルフ - オンラインで遊べる人狼ゲームアプリ</title>
    <!-- SEO対策：サイトの説明文を記述 -->
    <meta name="description" content="複数人でリアルタイムに遊べるワードウルフのオンラインアプリ。友達と単語ペアを作成・共有して、市民と人狼に分かれて議論を楽しもう。">
    <!-- SEO対策：関連キーワードを記述 -->
    <meta name="keywords" content="ワードウルフ, 人狼, オンライン, ゲーム, アプリ, 複数人, 協力, 議論, 無料">
    <!-- OGP設定：SNSでの共有時に表示される情報を設定 -->
    <meta property="og:title" content="ワードウルフ - オンラインで遊べる人狼ゲームアプリ">
    <meta property="og:description" content="みんなで遊べるオンラインワードウルフアプリ。単語ペアを共有して、市民と人狼に分かれて議論を楽しもう。リアルタイム同期で友達と盛り上がれる。">
    <meta property="og:type" content="website">
    <!-- このアプリをホストするURLに置き換えてください -->
    <meta property="og:url" content="https://your-github-username.github.io/your-repo-name/">
    <!-- スクリーンショット画像などを指定できます -->
    <!-- <meta property="og:image" content="https://example.com/wordwolf-screenshot.png"> -->
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
        }
        .editable-name {
            cursor: pointer;
            transition: color 0.2s;
        }
        .editable-name:hover {
            color: #93c5fd; /* Tailwind's blue-300 */
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <!-- SEO対策：アプリの紹介コンテンツをトップに追加 (簡略化) -->
    <div class="bg-[#2a2a44] p-6 sm:p-8 rounded-2xl shadow-2xl max-w-lg w-full mb-6 text-center">
        <!-- SEO対策：ページ全体を代表するメインの見出し -->
        <h1 class="text-3xl sm:text-4xl font-bold mb-4 text-white">ワードウルフ オンライン</h1>
        <p class="text-gray-300 mb-4">
            友達や家族と楽しめる、リアルタイム同期型のワードウルフアプリです。
        </p>
    </div>

    <div id="app-container" class="bg-[#2a2a44] p-6 sm:p-8 rounded-2xl shadow-2xl max-w-lg w-full">
        <!-- メインゲームコンテンツはここに描画されます -->
        <div id="game-content">
             <div class="flex items-center justify-center h-48">
                <div class="loading-spinner"></div>
            </div>
        </div>
        <div id="app-info" class="mt-4 text-xs text-gray-500 text-center space-y-1">
            <p>App ID: <span id="app-id-display"></span></p>
            <p>User ID: <span id="user-id-display"></span></p>
        </div>
    </div>

    <!-- 単語ペア編集用モーダル -->
    <div id="word-pair-modal" class="modal fixed inset-0 hidden items-center justify-center">
        <div class="bg-[#2a2a44] p-6 sm:p-8 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-white">単語セットの編集</h2>
            
            <p class="text-gray-400 mb-4">
                単語ペアを追加・編集できます。<br>
                ゲーム開始時にランダムに市民とウルフに割り振られます。
            </p>
            
            <div id="word-pair-list" class="mb-4"></div>
            
            <div class="flex flex-col md:flex-row gap-2 mb-4">
                <input type="text" id="new-word-1-input" placeholder="単語A" class="flex-1 p-3 rounded-lg bg-[#1a1a2e] text-white focus:outline-none focus:ring-2 focus:ring-[#6f50b4]">
                <input type="text" id="new-word-2-input" placeholder="単語B" class="flex-1 p-3 rounded-lg bg-[#1a1a2e] text-white focus:outline-none focus:ring-2 focus:ring-[#6f50b4]">
            </div>
            <button onclick="addWordPair()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                単語ペアを追加
            </button>
            
            <button onclick="closeWordPairModal()" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                閉じる
            </button>
        </div>
    </div>
    
    <!-- 単語ペア選択用モーダル -->
    <div id="select-word-modal" class="modal fixed inset-0 hidden items-center justify-center">
        <div class="bg-[#2a2a44] p-6 sm:p-8 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-white">単語を選んでゲーム開始</h2>
            
            <h3 class="text-xl font-bold text-white mb-2 text-center">プレイ回数ランキング</h3>

            <div id="select-word-list" class="mb-4"></div>
            
            <button onclick="closeSelectWordModal()" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                閉じる
            </button>
        </div>
    </div>
    
    <!-- カスタムメッセージ用モーダル -->
    <div id="custom-message-modal" class="modal fixed inset-0 hidden items-center justify-center">
        <div id="custom-message-content" class="bg-[#2a2a44] p-6 sm:p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <!-- showCustomMessage関数によってコンテンツがここに挿入されます -->
        </div>
    </div>

    <!-- Firebase SDKをインポート -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, deleteDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // グローバル変数としてゲームの状態を管理
        window.gameState = {
            players: [],
            words: [],
            wolfIndices: [],
            gamePhase: 'start',
            currentPlayerIndex: 0,
            voteCounts: {},
            civilianWord: '',
            wolfWord: '',
            timerDuration: 300, // 5 minutes
            timerId: null,
            isWordVisible: false,
            lastPlayedWordPair: null
        };
        
        // Firebase関連の変数
        let db;
        let auth;
        let userId;

        let wordPairs = [];
        
        const defaultPlayerNames = Array.from({length: 10}, (_, i) => `プレイヤー${i + 1}`);
        let numPlayers = 3;
        let numWolves = 1;
        
        // Firestoreパス
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const collectionPath = `artifacts/${appId}/public/data/wordPairs`;


        // --- Firebaseの初期化と認証 ---
        async function initializeFirebase() {
            try {
                // 環境変数から設定を取得
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                if (Object.keys(firebaseConfig).length === 0) {
                     throw new Error("Firebase config is not available.");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                // カスタムトークン認証
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('app-id-display').textContent = appId;
                        document.getElementById('user-id-display').textContent = userId;
                        setupFirestoreListener();
                    } else {
                        userId = null;
                        document.getElementById('app-id-display').textContent = appId;
                        document.getElementById('user-id-display').textContent = 'Signed out';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                document.getElementById('game-content').innerHTML = `
                    <div class="text-center text-red-500">
                        <p>アプリの読み込みに失敗しました。</p>
                        <p>エラー: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Firestoreリスナーの設定（リアルタイム更新用）
        function setupFirestoreListener() {
            if (!db) return;
            const q = query(collection(db, collectionPath));
            
            onSnapshot(q, (querySnapshot) => {
                const fetchedWordPairs = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    fetchedWordPairs.push({ id: doc.id, ...data });
                });
                wordPairs = fetchedWordPairs;
                render();
            }, (error) => {
                console.error("Failed to listen to Firestore:", error);
                showCustomMessage('エラー', '単語リストの取得に失敗しました。');
            });
        }


        // --- Firestoreの操作関数 ---
        async function addWordPair() {
            if (!db) return;
            const word1 = document.getElementById('new-word-1-input').value.trim();
            const word2 = document.getElementById('new-word-2-input').value.trim();
            if (word1 && word2) {
                try {
                    await addDoc(collection(db, collectionPath), {
                        word1: word1,
                        word2: word2,
                        playCount: 0
                    });
                    document.getElementById('new-word-1-input').value = '';
                    document.getElementById('new-word-2-input').value = '';
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showCustomMessage('エラー', '単語ペアの追加に失敗しました。');
                }
            }
        }
        
        async function removeWordPair(id) {
            if (!db) return;
            showCustomMessage(
                '単語ペア削除',
                'この単語ペアを本当に削除しますか？',
                async () => {
                    try {
                        await deleteDoc(doc(db, collectionPath, id));
                    } catch (e) {
                        console.error("Error removing document: ", e);
                        showCustomMessage('エラー', '単語ペアの削除に失敗しました。');
                    }
                },
                () => {}
            );
        }
        
        async function incrementPlayCount(wordPairId) {
            if (!db) return;
            try {
                const docRef = doc(db, collectionPath, wordPairId);
                const currentPair = wordPairs.find(p => p.id === wordPairId);
                if (currentPair) {
                    await updateDoc(docRef, {
                        playCount: currentPair.playCount + 1
                    });
                }
            } catch (e) {
                console.error("Error updating play count: ", e);
            }
        }

        // --- ゲームロジックの関数 ---
        function getCurrentPlayer() { return gameState.players[gameState.currentPlayerIndex]; }
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function setupGame(predefinedWords = null, playCountIncrementId = null) {
            if (wordPairs.length < 1 && !predefinedWords) {
                showCustomMessage('ゲーム開始', 'ゲームを始めるには、少なくとも1組の単語ペアが必要です。');
                return;
            }
            if (gameState.players.length < 3) {
                 showCustomMessage('ゲーム開始', 'ゲームを始めるには、最低3人のプレイヤーが必要です。');
                return;
            }
            
            let allWords = [];
            let selectedWords;

            if (predefinedWords) {
                selectedWords = { word1: predefinedWords.word1, word2: predefinedWords.word2 };
                gameState.lastPlayedWordPair = selectedWords;
            } else {
                selectedWords = wordPairs[Math.floor(Math.random() * wordPairs.length)];
                if (selectedWords) {
                     incrementPlayCount(selectedWords.id);
                } else {
                    showCustomMessage('エラー', '単語リストが空です。単語を追加してください。');
                    return;
                }
            }
            
            const isWordSwapped = Math.random() < 0.5;
            gameState.civilianWord = isWordSwapped ? selectedWords.word2 : selectedWords.word1;
            gameState.wolfWord = isWordSwapped ? selectedWords.word1 : selectedWords.word2;

            for (let i = 0; i < numWolves; i++) {
                allWords.push(gameState.wolfWord);
            }
            for (let i = 0; i < numPlayers - numWolves; i++) {
                allWords.push(gameState.civilianWord);
            }

            if (predefinedWords) {
                const userWord = predefinedWords.word1;
                let userWordIndex = -1;
                while (userWordIndex === -1) {
                    shuffleArray(allWords);
                    userWordIndex = allWords.indexOf(userWord);
                }
                [allWords[0], allWords[userWordIndex]] = [allWords[userWordIndex], allWords[0]];
            } else {
                shuffleArray(allWords);
            }

            gameState.wolfIndices = [];
            gameState.players.forEach((player, index) => {
                player.word = allWords[index];
                player.isWolf = (player.word === gameState.wolfWord);
                if (player.isWolf) {
                    gameState.wolfIndices.push(index);
                }
            });

            if (playCountIncrementId) {
                incrementPlayCount(playCountIncrementId);
            }

            gameState.gamePhase = 'confirmPlayer';
            gameState.currentPlayerIndex = 0;
            gameState.voteCounts = {};
            gameState.isWordVisible = false;
            render();
        }
        
        function startSelectedGame(id) {
            const selectedPair = wordPairs.find(p => p.id === id);
            if (selectedPair) {
                setupGame({ word1: selectedPair.word1, word2: selectedPair.word2 }, selectedPair.id);
                closeSelectWordModal();
            }
        }


        function handleVote(votedPlayerId) {
             const votedPlayer = gameState.players.find(p => p.id === votedPlayerId);
             showCustomMessage(
                '投票の確認',
                `本当に${votedPlayer.name}さんに投票しますか？`,
                () => {
                    stopTimer();
                    if (gameState.voteCounts[votedPlayerId]) {
                        gameState.voteCounts[votedPlayerId]++;
                    } else {
                        gameState.voteCounts[votedPlayerId] = 1;
                    }
                    gameState.gamePhase = 'results';
                    render();
                },
                () => {}
            );
        }

        function startTimer() {
            if (gameState.timerId) clearInterval(gameState.timerId);
            gameState.timerId = setInterval(() => {
                if (gameState.timerDuration <= 0) {
                    stopTimer();
                    showCustomMessage('時間切れ', '議論時間が終了しました！投票に進んでください。');
                } else {
                    gameState.timerDuration--;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function stopTimer() {
            if (gameState.timerId) {
                clearInterval(gameState.timerId);
                gameState.timerId = null;
            }
        }

        function updateTimerDisplay() {
            const timerElement = document.getElementById('timer-display');
            if (timerElement) {
                const minutes = Math.floor(gameState.timerDuration / 60);
                const seconds = gameState.timerDuration % 60;
                timerElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }

        // --- UIレンダリング関数 ---
        function render() {
            const gameContent = document.getElementById('game-content');
            
            // Standalone version doesn't need to wait for Firebase
            switch (gameState.gamePhase) {
                case 'start':
                    stopTimer();
                    renderStartScreen(gameContent);
                    break;
                case 'confirmPlayer':
                    renderConfirmPlayerScreen(gameContent);
                    break;
                case 'reveal':
                    renderRevealScreen(gameContent);
                    break;
                case 'vote':
                    renderVoteScreen(gameContent);
                    break;
                case 'results':
                    renderResultsScreen(gameContent);
                    break;
            }
        }

        function renderStartScreen(container) {
            if (gameState.players.length !== numPlayers) {
                const newPlayers = [];
                for (let i = 0; i < numPlayers; i++) {
                    const existingPlayer = gameState.players[i];
                    if (existingPlayer) {
                        newPlayers.push(existingPlayer);
                    } else {
                        newPlayers.push({ id: crypto.randomUUID(), name: defaultPlayerNames[i] });
                    }
                }
                gameState.players = newPlayers;
            }
            
            const playersHtml = gameState.players.map(player => `
                <li class="flex items-center justify-between p-2 my-2 bg-[#3b3b5c] rounded-lg">
                    <span id="player-name-${player.id}" class="text-xl font-bold editable-name" onclick="editPlayerName('${player.id}')">${player.name}</span>
                    <button onclick="removePlayer('${player.id}')" class="text-red-400 hover:text-red-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586l-1.293-1.293z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </li>
            `).join('');

            const initialMinutes = gameState.timerDuration / 60;

            container.innerHTML = `
                <!-- SEO対策：アプリのメインタイトルはh1が既に使われているため、h2を使用 -->
                <h2 class="text-2xl font-bold mb-6 text-center text-white">ゲーム設定</h2>
                
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-white mb-2 text-center">プレイヤー人数</h3>
                    <div class="flex items-center justify-center gap-4">
                        <button onclick="decrementPlayers()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg transition-colors text-xl">
                            &lt;
                        </button>
                        <span class="text-4xl font-extrabold text-white" id="player-count">${numPlayers}</span>
                        <button onclick="incrementPlayers()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg transition-colors text-xl">
                            &gt;
                        </button>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-base font-bold text-white mb-2 text-center">人狼の人数</h3>
                    <div class="flex items-center justify-center gap-4">
                        <button onclick="decrementWolves()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg transition-colors text-xl">
                            &lt;
                        </button>
                        <span class="text-4xl font-extrabold text-white" id="wolf-count">${numWolves}</span>
                        <button onclick="incrementWolves()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg transition-colors text-xl">
                            &gt;
                        </button>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-base font-bold text-white mb-2 text-center">議論時間</h3>
                    <div class="flex items-center justify-center gap-4">
                        <button onclick="decrementTimerDuration()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg transition-colors text-xl">
                            &lt;
                        </button>
                        <span class="text-4xl font-extrabold text-white" id="timer-setting">${initialMinutes}分</span>
                        <button onclick="incrementTimerDuration()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg transition-colors text-xl">
                            &gt;
                        </button>
                    </div>
                </div>
                
                <ul id="players-list" class="mb-6 space-y-2">
                    ${playersHtml}
                </ul>
                
                <div class="flex gap-2">
                    <button onclick="setupGame()" class="flex-1 py-4 rounded-lg font-bold transition-all text-lg bg-green-500 hover:bg-green-600">
                        ランダムでゲーム開始
                    </button>
                    <button onclick="openSelectWordModal()" class="flex-1 py-4 rounded-lg font-bold transition-all text-lg bg-blue-500 hover:bg-blue-600">
                        単語を選んでゲーム開始
                    </button>
                </div>
                
                <button onclick="openWordPairModal()" class="w-full mt-2 py-4 rounded-lg font-bold transition-all text-lg bg-gray-600 hover:bg-gray-700">
                    単語セットを編集
                </button>
                
                <!-- 遊び方ボタンを追加 -->
                <button onclick="showHowToPlayModal()" class="w-full mt-2 py-4 rounded-lg font-bold transition-all text-lg bg-gray-600 hover:bg-gray-700">
                    遊び方
                </button>
            `;
        }

        function renderConfirmPlayerScreen(container) {
            const currentPlayer = getCurrentPlayer();
            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-center text-white">単語の確認</h2>
                <p class="text-gray-400 mb-6 text-center text-xl font-bold">
                    ${currentPlayer.name} さん、あなたの番ですか？
                </p>
                <div class="text-center flex flex-col items-center">
                    <button onclick="confirmPlayer()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-lg transition-colors text-lg w-full max-w-sm">
                        はい
                    </button>
                    <button onclick="resetGame()" class="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-base w-full max-w-sm">
                        いいえ（ゲームをやり直す）
                    </button>
                </div>
            `;
        }

        function renderRevealScreen(container) {
            const currentPlayer = getCurrentPlayer();
            const isLastPlayer = gameState.currentPlayerIndex === gameState.players.length - 1;
            const wordBoxHiddenClass = gameState.isWordVisible ? '' : 'hidden';
            const showBtnHiddenClass = gameState.isWordVisible ? 'hidden' : '';
            const nextBtnHiddenClass = gameState.isWordVisible ? '' : 'hidden';
            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-center text-white">${currentPlayer.name}さんの番です。</h2>
                <p class="text-gray-400 mb-6 text-center">
                    他のプレイヤーに見られないように単語を確認してください。
                </p>
                <div class="text-center flex flex-col items-center">
                    <div id="word-box" class="text-5xl font-extrabold text-white bg-[#3b3b5c] p-10 rounded-xl shadow-inner mb-6 transition-all duration-300 ${wordBoxHiddenClass}">
                        ${currentPlayer.word}
                    </div>
                    <button id="show-word-btn" onclick="showWord()" class="bg-[#6f50b4] hover:bg-[#8d71c4] text-white font-bold py-4 px-8 rounded-lg transition-colors text-lg w-full max-w-sm ${showBtnHiddenClass}">
                        単語を表示
                    </button>
                    <button id="next-player-btn" onclick="nextPlayer()" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-lg transition-colors text-lg w-full max-w-sm ${nextBtnHiddenClass}">
                        ${isLastPlayer ? '議論開始' : '次のプレイヤー'}
                    </button>
                    <button onclick="confirmRestart()" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-base w-full max-w-sm ${nextBtnHiddenClass}">
                        単語を変更
                    </button>
                </div>
            `;
        }

        function renderVoteScreen(container) {
            const playersHtml = gameState.players.map(player => `
                <li class="flex items-center justify-between p-3 my-2 bg-[#3b3b5c] rounded-lg">
                    <span class="text-lg">${player.name}</span>
                    <button onclick="handleVote('${player.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                        投票
                    </button>
                </li>
            `).join('');

            const minutes = Math.floor(gameState.timerDuration / 60);
            const seconds = gameState.timerDuration % 60;
            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-center text-white">議論と投票</h2>
                <p class="text-gray-400 mb-6 text-center">
                    みんなで議論して、ワードウルフだと思う人に投票してください。
                </p>
                <div class="flex items-center justify-center gap-4 mb-6">
                    <span id="timer-display" class="text-4xl font-extrabold text-white">
                        ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}
                    </span>
                    <button onclick="addTime()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-lg">
                        +1分
                    </button>
                </div>
                <ul class="space-y-3 mt-6">
                    ${playersHtml}
                </ul>
            `;
            startTimer();
        }

        function renderResultsScreen(container) {
            const winner = determineWinner();
            const voteResultHtml = getVoteResultHtml();
            const wordRevealHtml = getWordRevealHtml();

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-center text-white">結果発表</h2>
                
                <div class="text-center bg-[#3b3b5c] p-6 rounded-xl shadow-inner mb-6">
                    ${winner.isWolfsWin ? 
                        `<h3 class="text-4xl font-extrabold text-red-400 mb-4">人狼チームの勝利！</h3>` :
                        `<h3 class="text-4xl font-extrabold text-green-400 mb-4">市民チームの勝利！</h3>`
                    }
                    <p class="text-xl text-white">追放された人: ${winner.votedPlayer.name}</p>
                    <p class="text-xl text-white">追放された人の正体: ${winner.votedPlayer.isWolf ? '人狼' : '市民'}</p>
                </div>
                
                ${wordRevealHtml}
                
                ${voteResultHtml}
                
                <button onclick="resetGame()" class="w-full mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-4 rounded-lg transition-colors text-lg">
                    もう一度プレイ
                </button>
            `;
        }

        // 単語ペアリストのレンダリング
        function renderWordPairList() {
            const listContainer = document.getElementById('word-pair-list');
            if (!listContainer) return;
            listContainer.innerHTML = wordPairs.map(pair => `
                <div class="flex items-center p-3 my-2 bg-[#3b3b5c] rounded-lg">
                    <span class="flex-1 text-lg">${pair.word1} / ${pair.word2}</span>
                    <button onclick="removeWordPair('${pair.id}')" class="text-red-400 hover:text-red-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586l-1.293-1.293z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            `).join('');
        }
        
        // プレイ回数でソートした単語ペアリストのレンダリング
        function renderSelectWordList() {
             const listContainer = document.getElementById('select-word-list');
            if (!listContainer) return;

            const sortedWordPairs = [...wordPairs].sort((a, b) => b.playCount - a.playCount);

            listContainer.innerHTML = sortedWordPairs.map(pair => `
                <div class="flex items-center justify-between p-3 my-2 bg-[#3b3b5c] rounded-lg">
                    <div class="flex-1">
                        <span class="text-lg">${pair.word1} / ???</span>
                        <span class="text-sm text-gray-400 block">（プレイ回数: ${pair.playCount}回）</span>
                    </div>
                    <button onclick="startSelectedGame('${pair.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        この単語で開始
                    </button>
                </div>
            `).join('');
        }
        

        // --- UIイベントハンドラ関数 ---
        function addPlayer() {
            if (numPlayers < 10) {
                numPlayers++;
                gameState.players.push({ id: crypto.randomUUID(), name: defaultPlayerNames[numPlayers - 1] });
                document.getElementById('player-count').textContent = numPlayers;
                render();
            }
        }

        function removePlayer(id) {
            if (numPlayers > 3) {
                const index = gameState.players.findIndex(player => player.id === id);
                if (index > -1) {
                    gameState.players.splice(index, 1);
                    numPlayers--;
                    document.getElementById('player-count').textContent = numPlayers;
                    if (numWolves >= numPlayers) {
                        numWolves = numPlayers - 1;
                        document.getElementById('wolf-count').textContent = numWolves;
                    }
                    render();
                }
            } else {
                showCustomMessage('プレイヤー削除', 'プレイヤーは最低3人必要です。');
            }
        }

        function decrementPlayers() {
            if (numPlayers > 3) {
                numPlayers--;
                gameState.players.pop();
                document.getElementById('player-count').textContent = numPlayers;
                 if (numWolves >= numPlayers) {
                    numWolves = numPlayers - 1;
                    document.getElementById('wolf-count').textContent = numWolves;
                }
                render();
            }
        }

        function incrementPlayers() {
            if (numPlayers < 10) {
                numPlayers++;
                gameState.players.push({ id: crypto.randomUUID(), name: defaultPlayerNames[numPlayers - 1] });
                document.getElementById('player-count').textContent = numPlayers;
                render();
            }
        }

        function decrementWolves() {
            if (numWolves > 1) {
                numWolves--;
                document.getElementById('wolf-count').textContent = numWolves;
            }
        }

        function incrementWolves() {
            if (numWolves < numPlayers - 1) {
                numWolves++;
                document.getElementById('wolf-count').textContent = numWolves;
            }
        }

        function decrementTimerDuration() {
            if (gameState.timerDuration > 60) {
                gameState.timerDuration -= 60;
                document.getElementById('timer-setting').textContent = `${gameState.timerDuration / 60}分`;
            }
        }

        function incrementTimerDuration() {
            if (gameState.timerDuration < 600) {
                gameState.timerDuration += 60;
                document.getElementById('timer-setting').textContent = `${gameState.timerDuration / 60}分`;
            }
        }

        function editPlayerName(id) {
            const playerNameEl = document.getElementById(`player-name-${id}`);
            const currentName = playerNameEl.textContent;
            const newName = prompt(`新しい名前を入力してください (${currentName})`, currentName);
            if (newName && newName.trim() !== '') {
                const player = gameState.players.find(p => p.id === id);
                if (player) {
                    player.name = newName.trim();
                    playerNameEl.textContent = newName.trim();
                    const playerIndex = gameState.players.findIndex(p => p.id === id);
                    if (playerIndex !== -1 && playerIndex < defaultPlayerNames.length) {
                         defaultPlayerNames[playerIndex] = newName.trim();
                    }
                }
            }
        }
        
        function openWordPairModal() {
            renderWordPairList();
            document.getElementById('word-pair-modal').classList.remove('hidden');
            document.getElementById('word-pair-modal').classList.add('flex');
        }

        function closeWordPairModal() {
            document.getElementById('word-pair-modal').classList.remove('flex');
            document.getElementById('word-pair-modal').classList.add('hidden');
        }
        
        function openSelectWordModal() {
            renderSelectWordList();
            document.getElementById('select-word-modal').classList.remove('hidden');
            document.getElementById('select-word-modal').classList.add('flex');
        }

        function closeSelectWordModal() {
            document.getElementById('select-word-modal').classList.remove('flex');
            document.getElementById('select-word-modal').classList.add('hidden');
        }
        
        function showHowToPlayModal() {
            const title = "遊び方";
            const rules = `
ワードウルフは、市民と人狼に分かれて行う議論ゲームです。

1.  ゲーム開始時に、各プレイヤーにそれぞれのお題が提示されます。
    - 市民には同じお題。
    - 人狼には市民とは少し違うお題。

2.  プレイヤーは、自分のお題を直接言わずに、お題について議論をします。

3.  議論を通じて、市民は人狼が持つ異なるお題を見つけ出します。人狼は自分が人狼であることを悟られないように議論します。

4.  議論の最後に、誰が人狼だと思うか投票します。

5.  最も多く票を集めたプレイヤーが人狼だった場合、市民の勝利。市民だった場合、人狼の勝利となります。
            `;
            showCustomMessage(title, rules);
        }

        function confirmPlayer() {
            gameState.gamePhase = 'reveal';
            render();
        }

        function showWord() {
            gameState.isWordVisible = true;
            render();
        }

        function nextPlayer() {
            gameState.isWordVisible = false;
            gameState.currentPlayerIndex++;
            if (gameState.currentPlayerIndex < gameState.players.length) {
                gameState.gamePhase = 'confirmPlayer';
            } else {
                gameState.gamePhase = 'vote';
            }
            render();
        }
        
        function addTime() {
             gameState.timerDuration += 60;
             updateTimerDisplay();
        }

        function confirmRestart() {
            showCustomMessage(
                'ゲームリスタート',
                '単語を変更してゲームをやり直しますか？',
                () => {
                    gameState.gamePhase = 'start';
                    render();
                },
                () => {}
            );
        }

        function determineWinner() {
            const sortedVotes = Object.entries(gameState.voteCounts).sort(([, a], [, b]) => b - a);
            const mostVotedPlayerId = sortedVotes[0][0];
            const votedPlayer = gameState.players.find(p => p.id === mostVotedPlayerId);
            
            const isVotedPlayerWolf = votedPlayer.isWolf;
            const isVotedPlayerTheOnlyWolf = gameState.wolfIndices.length === 1 && isVotedPlayerWolf;
            const isVotedPlayerOneOfMultipleWolves = gameState.wolfIndices.length > 1 && isVotedPlayerWolf;
            
            const civilianWords = gameState.players.filter(p => !p.isWolf).map(p => p.word);
            const isAllCiviliansVotedForWolf = sortedVotes.every(([id, count]) => {
                const player = gameState.players.find(p => p.id === id);
                return player.isWolf || count === 0;
            });
            
            const isWolvesWin = (isVotedPlayerTheOnlyWolf && isAllCiviliansVotedForWolf) ? false : (isVotedPlayerTheOnlyWolf && !isAllCiviliansVotedForWolf);

            const isVotedPlayerWolfsWin = isVotedPlayerWolf === false;
            
            return {
                isWolfsWin: isVotedPlayerWolfsWin,
                votedPlayer: votedPlayer
            };
        }

        function getVoteResultHtml() {
            const sortedVotes = Object.entries(gameState.voteCounts).sort(([, a], [, b]) => b - a);
            const totalVotes = Object.values(gameState.voteCounts).reduce((sum, count) => sum + count, 0);

            const voteDetailsHtml = sortedVotes.map(([id, count]) => {
                const player = gameState.players.find(p => p.id === id);
                const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : 0;
                return `
                    <li class="flex items-center justify-between p-3 my-2 bg-[#1a1a2e] rounded-lg">
                        <span class="text-xl font-bold">${player.name}</span>
                        <div class="flex items-center">
                            <span class="text-xl font-bold text-white mr-2">${count}票</span>
                            <span class="text-sm text-gray-400">(${percentage}%)</span>
                        </div>
                    </li>
                `;
            }).join('');

            return `
                <div class="mt-8">
                    <h3 class="text-2xl font-bold mb-4 text-center text-white">投票結果詳細</h3>
                    <ul class="space-y-2">
                        ${voteDetailsHtml}
                    </ul>
                </div>
            `;
        }
        
        function getWordRevealHtml() {
            let playerWordsHtml = gameState.players.map(player => `
                <li class="flex items-center justify-between p-3 my-2 bg-[#1a1a2e] rounded-lg">
                    <span class="text-lg">${player.name}</span>
                    <span class="text-lg font-bold ${player.isWolf ? 'text-red-400' : 'text-green-400'}">${player.word} (${player.isWolf ? '人狼' : '市民'})</span>
                </li>
            `).join('');
            
            return `
                 <div class="mt-8">
                    <h3 class="text-2xl font-bold mb-4 text-center text-white">全員の単語</h3>
                    <p class="text-gray-400 text-center mb-2">市民の単語: <span class="font-bold text-green-400">${gameState.civilianWord}</span></p>
                    <p class="text-gray-400 text-center mb-4">人狼の単語: <span class="font-bold text-red-400">${gameState.wolfWord}</span></p>
                    <ul class="space-y-2">
                        ${playerWordsHtml}
                    </ul>
                </div>
            `;
        }

        function resetGame() {
            gameState.gamePhase = 'start';
            gameState.currentPlayerIndex = 0;
            gameState.voteCounts = {};
            gameState.isWordVisible = false;
            gameState.timerDuration = 300;
            render();
        }
        
        // Custom Modal Function (No window.alert)
        function showCustomMessage(title, message, onConfirm = null, onCancel = null) {
            const modalContainer = document.getElementById('custom-message-modal');
            const modalContent = document.getElementById('custom-message-content');
            
            modalContent.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-white">${title}</h2>
                <p class="text-gray-400 mb-6">${message}</p>
                <div class="flex gap-4">
                    ${onConfirm ? `<button onclick="confirmAction()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">はい</button>` : ''}
                    ${onConfirm ? `<button onclick="cancelAction()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">いいえ</button>` : ''}
                    ${!onConfirm ? `<button onclick="closeModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">閉じる</button>` : ''}
                </div>
            `;
            
            window.confirmAction = () => {
                if (onConfirm) onConfirm();
                modalContainer.classList.remove('flex');
                modalContainer.classList.add('hidden');
            };

            window.cancelAction = () => {
                if (onCancel) onCancel();
                modalContainer.classList.remove('flex');
                modalContainer.classList.add('hidden');
            };
            
            window.closeModal = () => {
                modalContainer.classList.remove('flex');
                modalContainer.classList.add('hidden');
            };

            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
        }


        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
             initializeFirebase();
        });

    </script>
</body>
</html>
