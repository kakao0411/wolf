<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Wolf アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
        }
        .editable-name {
            cursor: pointer;
            transition: color 0.2s;
        }
        .editable-name:hover {
            color: #93c5fd; /* Tailwind's blue-300 */
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <div id="app-container" class="bg-[#2a2a44] p-6 sm:p-8 rounded-2xl shadow-2xl max-w-lg w-full">
        <!-- Main game content will be rendered here -->
        <div id="game-content">
            <!-- Loading state is removed for this standalone version -->
        </div>
    </div>

    <!-- Modal for editing word pairs -->
    <div id="word-pair-modal" class="modal fixed inset-0 hidden items-center justify-center">
        <div class="bg-[#2a2a44] p-6 sm:p-8 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-white">単語セットの編集</h2>
            
            <p class="text-gray-400 mb-4">
                単語ペアを追加・編集できます。<br>
                ゲーム開始時にランダムに市民とウルフに割り振られます。
            </p>
            
            <div id="word-pair-list" class="mb-4"></div>
            
            <div class="flex flex-col md:flex-row gap-2 mb-4">
                <input type="text" id="new-word-1-input" placeholder="単語A" class="flex-1 p-3 rounded-lg bg-[#1a1a2e] text-white focus:outline-none focus:ring-2 focus:ring-[#6f50b4]">
                <input type="text" id="new-word-2-input" placeholder="単語B" class="flex-1 p-3 rounded-lg bg-[#1a1a2e] text-white focus:outline-none focus:ring-2 focus:ring-[#6f50b4]">
            </div>
            <button onclick="addWordPair()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                単語ペアを追加
            </button>
            <button onclick="addWordPairFromGemini()" id="gemini-word-pair-button" class="w-full mt-2 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                ✨ Geminiに単語ペアを提案してもらう
            </button>
            
            <button onclick="closeWordPairModal()" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                閉じる
            </button>
        </div>
    </div>
    
    <!-- Modal for Discussion Prompt -->
    <div id="discussion-modal" class="modal fixed inset-0 hidden items-center justify-center">
        <div class="bg-[#2a2a44] p-6 sm:p-8 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto text-center">
            <h2 class="text-2xl font-bold mb-4 text-white">議論のお題</h2>
            <p id="discussion-prompt-text" class="text-xl text-gray-300 mb-6"></p>
            <button onclick="this.parentNode.parentNode.remove()" class="w-full mt-4 bg-[#6f50b4] hover:bg-[#8d71c4] text-white font-bold py-3 px-4 rounded-lg transition-colors">
                閉じる
            </button>
        </div>
    </div>
    
    <!-- Modal for selecting a word pair from the list -->
    <div id="select-word-modal" class="modal fixed inset-0 hidden items-center justify-center">
        <div class="bg-[#2a2a44] p-6 sm:p-8 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-white">単語を選んでゲーム開始</h2>
            
            <button onclick="setupGame()" class="w-full mb-4 py-4 rounded-lg font-bold transition-all text-lg bg-green-500 hover:bg-green-600">
                ランダムで選んで開始
            </button>

            <div id="select-word-list" class="mb-4"></div>
            
            <button onclick="closeSelectWordModal()" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                閉じる
            </button>
        </div>
    </div>

    <!-- Modal for Gemini themed game, now a single word -->
    <div id="gemini-theme-modal" class="modal fixed inset-0 hidden items-center justify-center">
        <div class="bg-[#2a2a44] p-6 sm:p-8 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-white">単語を決めてゲーム開始</h2>
            <p class="text-gray-400 mb-4">
                一つの単語を入力してください。Geminiがもう一つの似た単語を提案します。<br>
                **最初のプレイヤーには、必ずあなたが入力した単語が割り当てられます。**
            </p>
            <input type="text" id="gemini-word-input" placeholder="例: テレビ" class="w-full p-3 rounded-lg bg-[#1a1a2e] text-white mb-4 focus:outline-none focus:ring-2 focus:ring-[#6f50b4]">
            
            <button onclick="startGeminiThemedGame()" id="start-gemini-themed-button" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                単語でゲーム開始
            </button>
            <button onclick="closeGeminiThemeModal()" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                閉じる
            </button>
        </div>
    </div>

    <!-- No Firebase SDKs, all logic is here -->
    <script>
        // グローバル変数としてゲームの状態を管理
        window.gameState = {
            players: [],
            words: [],
            wolfIndices: [],
            gamePhase: 'start',
            currentPlayerIndex: 0,
            voteCounts: {},
            civilianWord: '',
            wolfWord: '',
            timerDuration: 300,
            timerId: null,
            isWordVisible: false,
            lastPlayedWordPair: null // 最後にプレイした単語ペアを格納
        };

        // ローカルに単語ペアを保持
        let wordPairs = [];
        
        const defaultPlayerNames = Array.from({length: 10}, (_, i) => `プレイヤー${i + 1}`);
        let numPlayers = 3;
        let numWolves = 1;

        // Gemini API key. Replace with your own key.
        const apiKey = "YOUR_API_KEY_HERE";

        // --- localStorageの操作関数 ---
        function saveWordPairs() {
            localStorage.setItem('wordwolfWordPairs', JSON.stringify(wordPairs));
        }

        function loadWordPairs() {
            const storedPairs = localStorage.getItem('wordwolfWordPairs');
            if (storedPairs) {
                wordPairs = JSON.parse(storedPairs);
            } else {
                // 初回アクセス時のデフォルト単語セット
                wordPairs = [
                    { word1: 'チョコレート', word2: 'ココア', playCount: 0 },
                    { word1: '犬', word2: '猫', playCount: 0 },
                    { word1: 'テレビ', word2: 'ラジオ', playCount: 0 },
                ];
                saveWordPairs();
            }
        }


        // --- ゲームロジックの関数 ---
        function getCurrentPlayer() { return gameState.players[gameState.currentPlayerIndex]; }
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function setupGame(predefinedWords = null, playCountIncrementIndex = null) {
            if (wordPairs.length < 1 && !predefinedWords) {
                showCustomMessage('ゲーム開始', 'ゲームを始めるには、少なくとも1組の単語ペアが必要です。');
                return;
            }
            if (gameState.players.length < 3) {
                 showCustomMessage('ゲーム開始', 'ゲームを始めるには、最低3人のプレイヤーが必要です。');
                return;
            }
            
            let allWords = [];
            let selectedWords;

            if (predefinedWords) {
                selectedWords = { word1: predefinedWords.word1, word2: predefinedWords.word2 };
                // 最後にプレイした単語ペアとして保持
                gameState.lastPlayedWordPair = selectedWords;
            } else {
                // ランダムに単語ペアを選択
                selectedWords = wordPairs[Math.floor(Math.random() * wordPairs.length)];
                // プレイ回数をインクリメント
                const index = wordPairs.findIndex(p => p.word1 === selectedWords.word1 && p.word2 === selectedWords.word2);
                if (index !== -1) {
                    wordPairs[index].playCount++;
                    saveWordPairs();
                }
            }
            
            const isWordSwapped = Math.random() < 0.5;
            gameState.civilianWord = isWordSwapped ? selectedWords.word2 : selectedWords.word1;
            gameState.wolfWord = isWordSwapped ? selectedWords.word1 : selectedWords.word2;

            for (let i = 0; i < numWolves; i++) {
                allWords.push(gameState.wolfWord);
            }
            for (let i = 0; i < numPlayers - numWolves; i++) {
                allWords.push(gameState.civilianWord);
            }

            if (predefinedWords) {
                const userWord = predefinedWords.word1;
                let userWordIndex = -1;
                while (userWordIndex === -1) {
                    shuffleArray(allWords);
                    userWordIndex = allWords.indexOf(userWord);
                }
                [allWords[0], allWords[userWordIndex]] = [allWords[userWordIndex], allWords[0]];
            } else {
                shuffleArray(allWords);
            }

            gameState.wolfIndices = [];
            gameState.players.forEach((player, index) => {
                player.word = allWords[index];
                player.isWolf = (player.word === gameState.wolfWord);
                if (player.isWolf) {
                    gameState.wolfIndices.push(index);
                }
            });

            // 選択された単語でゲームを開始する場合
            if (playCountIncrementIndex !== null) {
                wordPairs[playCountIncrementIndex].playCount++;
                saveWordPairs();
            }

            gameState.gamePhase = 'confirmPlayer';
            gameState.currentPlayerIndex = 0;
            gameState.voteCounts = {};
            gameState.isWordVisible = false;
            render();
        }
        
        function startSelectedGame(index) {
            if (index >= 0 && index < wordPairs.length) {
                const selectedPair = wordPairs[index];
                setupGame({ word1: selectedPair.word1, word2: selectedPair.word2 }, index);
                closeSelectWordModal();
            }
        }


        function handleVote(votedPlayerId) {
             const votedPlayer = gameState.players.find(p => p.id === votedPlayerId);
             showCustomMessage(
                '投票の確認',
                `本当に${votedPlayer.name}さんに投票しますか？`,
                () => {
                    stopTimer();
                    if (gameState.voteCounts[votedPlayerId]) {
                        gameState.voteCounts[votedPlayerId]++;
                    } else {
                        gameState.voteCounts[votedPlayerId] = 1;
                    }
                    gameState.gamePhase = 'results';
                    render();
                },
                () => {}
            );
        }

        function startTimer() {
            if (gameState.timerId) clearInterval(gameState.timerId);
            gameState.timerId = setInterval(() => {
                if (gameState.timerDuration <= 0) {
                    stopTimer();
                    showCustomMessage('時間切れ', '議論時間が終了しました！投票に進んでください。');
                } else {
                    gameState.timerDuration--;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function stopTimer() {
            if (gameState.timerId) {
                clearInterval(gameState.timerId);
                gameState.timerId = null;
            }
        }

        function updateTimerDisplay() {
            const timerElement = document.getElementById('timer-display');
            if (timerElement) {
                const minutes = Math.floor(gameState.timerDuration / 60);
                const seconds = gameState.timerDuration % 60;
                timerElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }

        // --- UIレンダリング関数 ---
        function render() {
            const gameContent = document.getElementById('game-content');
            
            // Standalone version doesn't need to wait for Firebase
            switch (gameState.gamePhase) {
                case 'start':
                    stopTimer();
                    renderStartScreen(gameContent);
                    break;
                case 'confirmPlayer':
                    renderConfirmPlayerScreen(gameContent);
                    break;
                case 'reveal':
                    renderRevealScreen(gameContent);
                    break;
                case 'vote':
                    renderVoteScreen(gameContent);
                    break;
                case 'results':
                    renderResultsScreen(gameContent);
                    break;
            }
        }

        function renderStartScreen(container) {
            if (gameState.players.length !== numPlayers) {
                const newPlayers = [];
                for (let i = 0; i < numPlayers; i++) {
                    const existingPlayer = gameState.players[i];
                    if (existingPlayer) {
                        newPlayers.push(existingPlayer);
                    } else {
                        newPlayers.push({ id: crypto.randomUUID(), name: defaultPlayerNames[i] });
                    }
                }
                gameState.players = newPlayers;
            }
            
            const playersHtml = gameState.players.map(player => `
                <li class="flex items-center justify-between p-2 my-2 bg-[#3b3b5c] rounded-lg">
                    <span id="player-name-${player.id}" class="text-xl font-bold editable-name" onclick="editPlayerName('${player.id}')">${player.name}</span>
                    <button onclick="removePlayer('${player.id}')" class="text-red-400 hover:text-red-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586l-1.293-1.293z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </li>
            `).join('');

            const initialMinutes = gameState.timerDuration / 60;

            container.innerHTML = `
                <h1 class="text-2xl font-bold mb-6 text-center text-white">ワードウルフ</h1>
                
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-white mb-2 text-center">プレイヤー人数</h3>
                    <div class="flex items-center justify-center gap-4">
                        <button onclick="decrementPlayers()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg transition-colors text-xl">
                            &lt;
                        </button>
                        <span class="text-4xl font-extrabold text-white" id="player-count">${numPlayers}</span>
                        <button onclick="incrementPlayers()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg transition-colors text-xl">
                            &gt;
                        </button>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-base font-bold text-white mb-2 text-center">人狼の人数</h3>
                    <div class="flex items-center justify-center gap-4">
                        <button onclick="decrementWolves()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg transition-colors text-xl">
                            &lt;
                        </button>
                        <span class="text-4xl font-extrabold text-white" id="wolf-count">${numWolves}</span>
                        <button onclick="incrementWolves()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg transition-colors text-xl">
                            &gt;
                        </button>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-base font-bold text-white mb-2 text-center">議論時間</h3>
                    <div class="flex items-center justify-center gap-4">
                        <button onclick="decrementTimerDuration()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg transition-colors text-xl">
                            &lt;
                        </button>
                        <span class="text-4xl font-extrabold text-white" id="timer-setting">${initialMinutes}分</span>
                        <button onclick="incrementTimerDuration()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg transition-colors text-xl">
                            &gt;
                        </button>
                    </div>
                </div>
                
                <ul id="players-list" class="mb-6 space-y-2">
                    ${playersHtml}
                </ul>
                
                <div class="flex gap-2">
                    <button onclick="openGeminiThemeModal()" id="gemini-start-button" class="flex-1 py-4 rounded-lg font-bold transition-all text-lg bg-purple-500 hover:bg-purple-600">
                        単語入力でゲーム開始
                    </button>
                    <button onclick="openSelectWordModal()" class="flex-1 py-4 rounded-lg font-bold transition-all text-lg bg-blue-500 hover:bg-blue-600">
                        単語を選んでゲーム開始
                    </button>
                </div>
                
                <button onclick="openWordPairModal()" class="w-full mt-2 py-4 rounded-lg font-bold transition-all text-lg bg-gray-600 hover:bg-gray-700">
                    単語セットを編集
                </button>
            `;
        }
        
        function renderConfirmPlayerScreen(container) {
            const currentPlayer = getCurrentPlayer();
            const isLastPlayer = gameState.currentPlayerIndex === gameState.players.length - 1;
            
            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-center text-white">単語の確認</h2>
                <p class="text-gray-400 mb-6 text-center text-xl font-bold">
                    ${currentPlayer.name} さん、あなたの番ですか？
                </p>

                <div class="text-center flex flex-col items-center">
                    <button onclick="confirmPlayer()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-lg transition-colors text-lg w-full max-w-sm">
                        はい
                    </button>
                    <button onclick="resetGame()" class="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-base w-full max-w-sm">
                        いいえ（ゲームをやり直す）
                    </button>
                </div>
            `;
        }

        function renderRevealScreen(container) {
            const currentPlayer = getCurrentPlayer();
            const isLastPlayer = gameState.currentPlayerIndex === gameState.players.length - 1;
            
            const wordBoxHiddenClass = gameState.isWordVisible ? '' : 'hidden';
            const showBtnHiddenClass = gameState.isWordVisible ? 'hidden' : '';
            const nextBtnHiddenClass = gameState.isWordVisible ? '' : 'hidden';

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-center text-white">${currentPlayer.name}さんの番です。</h2>
                <p class="text-gray-400 mb-6 text-center">
                    他のプレイヤーに見られないように単語を確認してください。
                </p>

                <div class="text-center flex flex-col items-center">
                    <div id="word-box" class="text-5xl font-extrabold text-white bg-[#3b3b5c] p-10 rounded-xl shadow-inner mb-6 transition-all duration-300 ${wordBoxHiddenClass}">
                        ${currentPlayer.word}
                    </div>
                    <button id="show-word-btn" onclick="showWord()" class="bg-[#6f50b4] hover:bg-[#8d71c4] text-white font-bold py-4 px-8 rounded-lg transition-colors text-lg w-full max-w-sm ${showBtnHiddenClass}">
                        単語を表示
                    </button>
                    <button id="next-player-btn" onclick="nextPlayer()" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-lg transition-colors text-lg w-full max-w-sm ${nextBtnHiddenClass}">
                        ${isLastPlayer ? '議論開始' : '次のプレイヤー'}
                    </button>
                    <button onclick="confirmRestart()" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-base w-full max-w-sm ${nextBtnHiddenClass}">
                        単語を変更
                    </button>
                </div>
            `;
        }

        function renderVoteScreen(container) {
            const playersHtml = gameState.players.map(player => `
                <li class="flex items-center justify-between p-3 my-2 bg-[#3b3b5c] rounded-lg">
                    <span class="text-lg">${player.name}</span>
                    <button onclick="handleVote('${player.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                        投票
                    </button>
                </li>
            `).join('');

            const minutes = Math.floor(gameState.timerDuration / 60);
            const seconds = gameState.timerDuration % 60;

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-center text-white">議論と投票</h2>
                <p class="text-gray-400 mb-6 text-center">
                    みんなで議論して、ワードウルフだと思う人に投票してください。
                </p>

                <div class="flex items-center justify-center gap-4 mb-6">
                    <span id="timer-display" class="text-4xl font-extrabold text-white">
                        ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}
                    </span>
                    <button onclick="addTime()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-lg">
                        +1分
                    </button>
                </div>
                
                <button onclick="generateDiscussionPrompt()" id="gemini-discussion-button" class="w-full mt-4 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                    ✨ Geminiに質問を考えてもらう
                </button>

                <ul class="space-y-3 mt-6">
                    ${playersHtml}
                </ul>
            `;
            startTimer();
        }
        
        async function renderResultsScreen(container) {
            // ローカルストレージに保存
            if (gameState.lastPlayedWordPair) {
                const isDuplicate = wordPairs.some(pair => 
                    (pair.word1 === gameState.lastPlayedWordPair.word1 && pair.word2 === gameState.lastPlayedWordPair.word2) ||
                    (pair.word1 === gameState.lastPlayedWordPair.word2 && pair.word2 === gameState.lastPlayedWordPair.word1)
                );
                
                if (!isDuplicate) {
                    wordPairs.push({ ...gameState.lastPlayedWordPair, playCount: 0 });
                    saveWordPairs(); // localStorageに保存
                }
                gameState.lastPlayedWordPair = null; // 保存後、リセット
            }

            let votedOutPlayerId = '';
            let maxVotes = 0;
            for (const id in gameState.voteCounts) {
                if (gameState.voteCounts[id] > maxVotes) {
                    maxVotes = gameState.voteCounts[id];
                    votedOutPlayerId = id;
                }
            }

            const votedOutPlayer = gameState.players.find(p => p.id === votedOutPlayerId);
            const isWolfVotedOut = votedOutPlayer ? votedOutPlayer.isWolf : false;
            
            let winnerMessage = '';
            if (isWolfVotedOut) {
                winnerMessage = '市民チーム';
            } else {
                winnerMessage = '人狼チーム';
            }
            
            const votedOutPlayerName = votedOutPlayer ? votedOutPlayer.name : 'なし';

            const playerResultsHtml = gameState.players.map((player) => {
                const roleText = player.isWolf ? '人狼' : '市民';
                const highlightClass = 'bg-[#3b3b5c] text-white';

                let winLossText = '';
                if (isWolfVotedOut) {
                    if (player.isWolf) {
                        winLossText = '敗北';
                    } else {
                        winLossText = '勝利';
                    }
                } else {
                    if (player.isWolf) {
                        winLossText = '勝利';
                    } else {
                        winLossText = '敗北';
                    }
                }
                
                const winLossClass = winLossText === '勝利' ? 'text-green-400' : 'text-red-400';
                
                return `
                    <li class="flex justify-between items-center p-3 my-2 rounded-lg shadow-md ${highlightClass}">
                        <div class="flex-1 flex items-center justify-start">
                            <span class="font-bold mr-2">${player.name}</span>
                            <span class="text-sm px-2 py-1 rounded-full ${player.isWolf ? 'bg-red-800' : 'bg-green-800'}">${roleText}</span>
                        </div>
                        <div class="w-24 font-semibold text-lg text-white text-center">
                            ${player.word}
                        </div>
                        <div class="w-16 font-bold text-center ${winLossClass}">
                            ${winLossText}
                        </div>
                    </li>
                `;
            }).join('');


            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-2 text-center text-white">勝者: ${winnerMessage}</h2>
                <h3 class="text-xl font-bold mb-4 text-center text-gray-400">追放者: ${votedOutPlayerName}</h3>
                
                <div class="mb-6">
                    <ul class="list-none">
                        ${playerResultsHtml}
                    </ul>
                </div>

                <button onclick="resetGame()" class="w-full bg-[#6f50b4] hover:bg-[#8d71c4] text-white font-bold py-4 px-8 rounded-lg transition-colors text-lg">
                    もう一度プレイ
                </button>
            `;
        }
        
        // --- イベントハンドラ ---
        function incrementPlayers() {
            if (numPlayers < 10) {
                numPlayers++;
                if (numWolves >= Math.floor(numPlayers / 2)) {
                    numWolves = Math.floor(numPlayers / 2) - 1;
                }
                if (numWolves < 1 && numPlayers >= 2) {
                    numWolves = 1;
                }
                render();
            }
        }
        
        function decrementPlayers() {
            if (numPlayers > 3) {
                numPlayers--;
                if (numWolves >= Math.floor(numPlayers / 2)) {
                    numWolves = Math.floor(numPlayers / 2) - 1;
                }
                if (numWolves < 1) {
                    numWolves = 1;
                }
                render();
            } else {
                 showCustomMessage('プレイヤー削除', 'ゲームを始めるには、最低3人のプレイヤーが必要です。');
            }
        }

        function incrementWolves() {
            if (numWolves < Math.floor(numPlayers / 2)) {
                numWolves++;
                render();
            }
        }
        
        function decrementWolves() {
            if (numWolves > 1) {
                numWolves--;
                render();
            }
        }

        function incrementTimerDuration() {
            const currentMinutes = gameState.timerDuration / 60;
            if (currentMinutes < 10) {
                gameState.timerDuration += 60;
                render();
            }
        }
        
        function decrementTimerDuration() {
            const currentMinutes = gameState.timerDuration / 60;
            if (currentMinutes > 1) {
                gameState.timerDuration -= 60;
                render();
            }
        }

        function addTime() {
            gameState.timerDuration += 60;
            updateTimerDisplay();
        }

        function editPlayerName(playerId) {
            const player = gameState.players.find(p => p.id === playerId);
            if (!player) return;

            const playerNameElement = document.getElementById(`player-name-${playerId}`);
            const originalName = player.name;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalName;
            input.className = 'bg-[#1a1a2e] text-white p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-[#6f50b4]';
            input.onblur = (e) => {
                const newName = e.target.value.trim();
                if (newName) {
                    player.name = newName;
                }
                render();
            };
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
            
            playerNameElement.replaceWith(input);
            input.focus();
        }

        function removePlayer(playerId) {
            if (numPlayers > 3) {
                gameState.players = gameState.players.filter(player => player.id !== playerId);
                numPlayers--;
                if (numWolves >= Math.floor(numPlayers / 2)) {
                    numWolves = Math.floor(numPlayers / 2) - 1;
                }
                if (numWolves < 1) {
                    numWolves = 1;
                }
                render();
            } else {
                 showCustomMessage('プレイヤー削除', 'ゲームを始めるには、最低3人のプレイヤーが必要です。');
            }
        }
        
        function confirmPlayer() {
            gameState.gamePhase = 'reveal';
            render();
        }

        function showWord() {
            gameState.isWordVisible = true;
            render();
        }

        function nextPlayer() {
            gameState.isWordVisible = false;
            if (gameState.currentPlayerIndex < gameState.players.length - 1) {
                gameState.currentPlayerIndex++;
                gameState.gamePhase = 'confirmPlayer';
                render();
            } else {
                gameState.gamePhase = 'vote';
                render();
            }
        }

        function confirmRestart() {
            const onConfirm = () => { restartWithNewWords(); };
            const onCancel = () => {
                gameState.isWordVisible = true;
                render();
            };

            showCustomMessage(
                '確認',
                '本当に単語を変更してゲームを再スタートしますか？',
                onConfirm,
                onCancel
            );
        }

        function restartWithNewWords() {
            setupGame();
        }

        function resetGame() {
            gameState.gamePhase = 'start';
            stopTimer();
            gameState.timerDuration = 300; 

            gameState.players.forEach(player => {
                player.word = '';
                player.isWolf = false;
            });
            gameState.words = [];
            gameState.wolfIndices = [];
            gameState.currentPlayerIndex = 0;
            gameState.voteCounts = {};
            gameState.civilianWord = '';
            gameState.wolfWord = '';
            gameState.isWordVisible = false;
            gameState.lastPlayedWordPair = null;

            render();
        }
        
        // --- 単語ペアモーダル関数 ---
        function openWordPairModal() {
            document.getElementById('word-pair-modal').classList.add('flex');
            document.getElementById('word-pair-modal').classList.remove('hidden');
            renderWordPairList();
        }
        
        function closeWordPairModal() {
            document.getElementById('word-pair-modal').classList.add('hidden');
            document.getElementById('word-pair-modal').classList.remove('flex');
            render();
        }
        
        function renderWordPairList() {
            const listContainer = document.getElementById('word-pair-list');
            listContainer.innerHTML = '';
            
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center text-sm font-bold text-gray-400 border-b border-gray-600 pb-2 mb-2';
            header.innerHTML = `
                <span class="w-12 text-left">No.</span>
                <span class="flex-1 text-center">単語A</span>
                <span class="flex-1 text-center">単語B</span>
                <span class="w-12 text-center">プレイ回数</span>
                <span class="w-12 text-right"></span>
            `;
            listContainer.appendChild(header);

            wordPairs.forEach((pair, index) => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 my-2 bg-[#3b3b5c] rounded-lg';
                item.innerHTML = `
                    <span class="w-12 font-bold text-left">${index + 1}.</span>
                    <span class="flex-1 text-center">${pair.word1}</span>
                    <span class="flex-1 text-center">${pair.word2}</span>
                    <span class="w-12 text-center">${pair.playCount || 0}</span>
                    <button onclick="removeWordPair(${index})" class="text-red-400 hover:text-red-300 transition-colors w-12 flex justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586l-1.293-1.293z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                listContainer.appendChild(item);
            });
        }
        
        async function addWordPair() {
            const word1Input = document.getElementById('new-word-1-input');
            const word2Input = document.getElementById('new-word-2-input');
            const word1 = word1Input.value.trim();
            const word2 = word2Input.value.trim();
            
            if (word1 && word2) {
                wordPairs.push({ word1: word1, word2: word2, playCount: 0 });
                word1Input.value = '';
                word2Input.value = '';
                saveWordPairs(); // localStorageに保存
                renderWordPairList();
            } else {
                showCustomMessage('単語の追加', '2つの単語を入力してください。');
            }
        }
        
        async function removeWordPair(index) {
            wordPairs.splice(index, 1);
            saveWordPairs(); // localStorageに保存
            renderWordPairList();
        }
        
        // --- 単語選択モーダル関数 ---
        function openSelectWordModal() {
            document.getElementById('select-word-modal').classList.add('flex');
            document.getElementById('select-word-modal').classList.remove('hidden');
            renderSelectWordList();
        }
        
        function closeSelectWordModal() {
            document.getElementById('select-word-modal').classList.add('hidden');
            document.getElementById('select-word-modal').classList.remove('flex');
        }
        
        function renderSelectWordList() {
            const listContainer = document.getElementById('select-word-list');
            listContainer.innerHTML = '';
            
            // プレイ回数が多い順にソート
            const sortedPairs = [...wordPairs].sort((a, b) => (b.playCount || 0) - (a.playCount || 0));

            const header = document.createElement('div');
            header.className = 'flex justify-between items-center text-sm font-bold text-gray-400 border-b border-gray-600 pb-2 mb-2';
            header.innerHTML = `
                <span class="w-12 text-left">No.</span>
                <span class="flex-1 text-center">単語A</span>
                <span class="flex-1 text-center">単語B</span>
                <span class="w-12 text-center">プレイ回数</span>
                <span class="w-24 text-right"></span>
            `;
            listContainer.appendChild(header);

            sortedPairs.forEach((pair, index) => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 my-2 bg-[#3b3b5c] rounded-lg';
                item.innerHTML = `
                    <span class="w-12 font-bold text-left">${index + 1}.</span>
                    <span class="flex-1 text-center">${pair.word1}</span>
                    <span class="flex-1 text-center">??</span>
                    <span class="w-12 text-center">${pair.playCount || 0}</span>
                    <button onclick="startSelectedGame(${wordPairs.indexOf(pair)})" class="w-24 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">
                        選択
                    </button>
                `;
                listContainer.appendChild(item);
            });
        }
        
        // --- Geminiテーマゲーム関数 ---
        function openGeminiThemeModal() {
             document.getElementById('gemini-theme-modal').classList.add('flex');
            document.getElementById('gemini-theme-modal').classList.remove('hidden');
        }

        function closeGeminiThemeModal() {
            document.getElementById('gemini-theme-modal').classList.add('hidden');
            document.getElementById('gemini-theme-modal').classList.remove('flex');
        }

        async function startGeminiThemedGame() {
            const wordInput = document.getElementById('gemini-word-input');
            const inputWord = wordInput.value.trim();
            if (!inputWord) {
                showCustomMessage('単語未入力', '単語を入力してください。');
                return;
            }

            if (apiKey === "YOUR_API_KEY_HERE" || !apiKey) {
                showCustomMessage('APIキーが未設定', 'Gemini APIキーを設定してください。');
                return;
            }

            const button = document.getElementById('start-gemini-themed-button');
            const originalButtonText = button.innerHTML;
            button.innerHTML = '<span class="loading-spinner"></span> 単語を生成中...';
            button.disabled = true;

            const maxRetries = 3;
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            try {
                // 既存の単語セットに存在するかチェック
                let existingPairIndex = wordPairs.findIndex(pair => pair.word1 === inputWord || pair.word2 === inputWord);
                
                if (existingPairIndex !== -1) {
                    // 既存の単語セットに一致する場合
                    wordPairs[existingPairIndex].playCount++;
                    saveWordPairs();
                    setupGame({ word1: wordPairs[existingPairIndex].word1, word2: wordPairs[existingPairIndex].word2 });
                    closeGeminiThemeModal();
                    return;
                }


                const prompt = `「${inputWord}」という単語と議論が白熱するような、同じレイヤー・カテゴリの単語を一つだけ、日本語で提案してください。例えば「大乱闘スマッシュブラザーズ」に対して「アクションゲーム」ではなく、「マリオカート」や「マインクラフト」のように、より具体的な単語にしてください。応答はJSON形式で、word1とword2のキーを持つオブジェクトの配列にしてください。word1は「${inputWord}」、word2はあなたが考えた単語にしてください。`;
                const chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "word1": { "type": "STRING" },
                                    "word2": { "type": "STRING" }
                                },
                                "propertyOrdering": ["word1", "word2"]
                            }
                        }
                    }
                };

                let response;
                let result;
                for (let i = 0; i <= maxRetries; i++) {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status !== 429) {
                            result = await response.json();
                            break;
                        }
                        await delay(1000 * (2 ** i));
                    } catch (error) {
                        console.error('Fetch error:', error);
                        throw error;
                    }
                }
                
                if (result && result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const newPairs = JSON.parse(jsonString);
                    
                    if (Array.isArray(newPairs) && newPairs.length > 0) {
                        const newWord1 = newPairs[0].word1;
                        const newWord2 = newPairs[0].word2;
                        
                        // 新しい単語ペアの場合
                        setupGame({ word1: newWord1, word2: newWord2 });
                        
                        closeGeminiThemeModal();
                    } else {
                        showCustomMessage('APIエラー', 'Geminiからの応答形式が正しくありませんでした。');
                    }
                } else {
                    showCustomMessage('APIエラー', 'Geminiからの応答がありませんでした。');
                }
            } catch (error) {
                console.error('Error generating themed word pairs:', error);
                showCustomMessage('エラー', '単語の生成中にエラーが発生しました。もう一度お試しください。');
            } finally {
                button.innerHTML = originalButtonText;
                button.disabled = false;
            }
        }
        
        // --- Gemini API連携関数 ---
        async function addWordPairFromGemini() {
            if (apiKey === "YOUR_API_KEY_HERE" || !apiKey) {
                showCustomMessage('APIキーが未設定', 'Gemini APIキーを設定してください。');
                return;
            }

            const button = document.getElementById('gemini-word-pair-button');
            const originalButtonText = button.innerHTML;
            button.innerHTML = '<span class="loading-spinner"></span> 提案中...';
            button.disabled = true;
            
            const maxRetries = 3;
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            try {
                const chatHistory = [];
                const prompt = "ワードウルフゲームのために、一般的な単語のペアを3つ提案してください。例えば「猫と犬」のように、関連しているが微妙に異なる単語のペアです。応答はJSON形式で、word1とword2のキーを持つオブジェクトの配列にしてください。word1とword2は必ず日本語で、同じテーマの単語にしてください。";
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "word1": { "type": "STRING" },
                                    "word2": { "type": "STRING" }
                                },
                                "propertyOrdering": ["word1", "word2"]
                            }
                        }
                    }
                };
                
                let response;
                let result;
                for (let i = 0; i <= maxRetries; i++) {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status !== 429) {
                            result = await response.json();
                            break;
                        }
                        await delay(1000 * (2 ** i));
                    } catch (error) {
                        console.error('Fetch error:', error);
                        throw error;
                    }
                }
                
                if (result && result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const newPairs = JSON.parse(jsonString);
                    
                    if (Array.isArray(newPairs)) {
                        newPairs.forEach(pair => {
                            if (pair.word1 && pair.word2) {
                                // 新しい単語ペアにplayCountを0で初期化
                                wordPairs.push({ ...pair, playCount: 0 });
                            }
                        });
                        saveWordPairs(); // localStorageに保存
                        renderWordPairList();
                        showCustomMessage('単語追加成功', 'Geminiが新しい単語ペアを提案してくれました！');
                    } else {
                         showCustomMessage('APIエラー', 'Geminiからの応答形式が正しくありませんでした。');
                    }
                } else {
                    showCustomMessage('APIエラー', 'Geminiからの応答がありませんでした。');
                }
            } catch (error) {
                console.error('Error generating word pairs:', error);
                showCustomMessage('エラー', '単語ペアの提案中にエラーが発生しました。もう一度お試しください。');
            } finally {
                button.innerHTML = originalButtonText;
                button.disabled = false;
            }
        }
        
        async function generateDiscussionPrompt() {
            if (apiKey === "YOUR_API_KEY_HERE" || !apiKey) {
                showCustomMessage('APIキーが未設定', 'Gemini APIキーを設定してください。');
                return;
            }

            const button = document.getElementById('gemini-discussion-button');
            const originalButtonText = button.innerHTML;
            button.innerHTML = '<span class="loading-spinner"></span> 質問を提案中...';
            button.disabled = true;
            
            const maxRetries = 3;
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            try {
                const prompt = `ワードウルフゲームのための議論のお題を提案してください。市民側の単語は「${gameState.civilianWord}」、ウルフ側の単語は「${gameState.wolfWord}」です。単語そのものを直接言わずに、二つの単語の違いが分かるような質問やシチュエーションを一つだけ、日本語で簡潔に提案してください。例：「もし一つだけ食べ物を選べるとしたら、何を食べる？」`;
                const chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                
                const payload = { contents: chatHistory };
                
                let response;
                let result;
                for (let i = 0; i <= maxRetries; i++) {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status !== 429) {
                            result = await response.json();
                            break;
                        }
                        await delay(1000 * (2 ** i));
                    } catch (error) {
                        console.error('Fetch error:', error);
                        throw error;
                    }
                }

                if (result && result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const discussionPrompt = result.candidates[0].content.parts[0].text.trim();
                    showDiscussionModal(discussionPrompt);
                } else {
                    showCustomMessage('APIエラー', '議論のお題の提案中にエラーが発生しました。');
                }
            } catch (error) {
                console.error('Error generating discussion prompt:', error);
                showCustomMessage('エラー', '議論のお題の提案中にエラーが発生しました。もう一度お試しください。');
            } finally {
                button.innerHTML = originalButtonText;
                button.disabled = false;
            }
        }
        
        function showDiscussionModal(promptText) {
            const modal = document.getElementById('discussion-modal');
            document.getElementById('discussion-prompt-text').textContent = promptText;
            modal.classList.add('flex');
            modal.classList.remove('hidden');
        }

        function showCustomMessage(title, message, onConfirm, onCancel) {
            const modalId = 'custom-message-box';
            let messageBox = document.getElementById(modalId);
            if (messageBox) {
                messageBox.remove();
            }

            messageBox = document.createElement('div');
            messageBox.id = modalId;
            messageBox.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';

            let buttonsHtml = `
                <button onclick="document.getElementById('${modalId}').remove()" class="bg-[#6f50b4] hover:bg-[#8d71c4] text-white font-bold py-2 px-6 rounded-lg transition-colors">OK</button>
            `;

            if (onConfirm && onCancel) {
                buttonsHtml = `
                    <button id="confirm-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">はい</button>
                    <button id="cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">いいえ</button>
                `;
            }

            messageBox.innerHTML = `
                <div class="bg-[#2a2a44] p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center">
                    <h3 class="text-xl font-bold text-white mb-4">${title}</h3>
                    <p class="text-gray-300 mb-6">${message}</p>
                    <div class="flex gap-4 justify-center">
                        ${buttonsHtml}
                    </div>
                </div>
            `;
            document.body.appendChild(messageBox);
            
            if (onConfirm && onCancel) {
                document.getElementById('confirm-btn').onclick = () => {
                    document.getElementById(modalId).remove();
                    onConfirm();
                };
                document.getElementById('cancel-btn').onclick = () => {
                    document.getElementById(modalId).remove();
                    onCancel();
                };
            }
        }

        // 初期化
        window.onload = function() {
            // localStorageから単語ペアをロード
            loadWordPairs();
            render();
        };

    </script>
</body>
</html>
